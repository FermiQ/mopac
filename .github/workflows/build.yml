name: Build multi-platform executables

on:
  push:
    branches:    
      - master

jobs:
  linux-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Clone glibc compatibility library
        uses: actions/checkout@v2
        with:
          repository: wheybags/glibc_version_header
          path: glibc

      - name: Install static MKL (BLAS & LAPACK) with Anaconda
        run: |
          conda install -c intel mkl-static
          echo "MKLROOT=$CONDA" >> $GITHUB_ENV

      - name: Configure with CMake
        run: |
          cmake -B build \
            -DCMAKE_Fortran_COMPILER=gfortran \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_Fortran_FLAGS="-static-libgfortran -static-libgcc -l:libquadmath.a" \
            -DCMAKE_C_FLAGS="-include $GITHUB_WORKSPACE/glibc/version_headers/x64/force_link_glibc_2.17.h" \
            -DBLA_STATIC=ON \
            -DBLA_VENDOR=Intel10_64lp

      - name: Build with Make
        run: cmake --build build

      - name: Tar executable to preserve permissions
        run: |
          tar -cvf mopac.tar -C build mopac
          tar -rf mopac.tar -C $CONDA/lib libiomp5.so

      - name: Save executable as an artifact
        uses: actions/upload-artifact@v2
        with:
          name: linux
          path: mopac.tar

  mac-build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2

      - name: Install static MKL (BLAS & LAPACK) with Anaconda
        run: |
          sudo chown -R runner:staff $CONDA
          conda install -c intel mkl-static
          echo "MKLROOT=$CONDA" >> $GITHUB_ENV

      - name: Configure with CMake
        run: |
          cmake -B build \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.8 \
            -DCMAKE_VERBOSE_MAKEFILE=ON \
            -DCMAKE_Fortran_COMPILER=gfortran-11 \
            -DCMAKE_C_COMPILER=gcc-11 \
            -DCMAKE_Fortran_FLAGS="-static-libgfortran -static-libgcc" \
            -DBLA_STATIC=ON \
            -DBLA_VENDOR=Intel10_64lp

      - name: Build with Make (static libquadmath workaround)
        run: |
          cat build/CMakeFiles/mopac.dir/build.make
          mv /usr/local/opt/gcc/lib/gcc/11/libquadmath.0.dylib renaming_workaround
          cmake --build build
          mv renaming_workaround /usr/local/opt/gcc/lib/gcc/11/libquadmath.0.dylib

      - name: Tar executable to preserve permissions
        run: |
          tar -cvf mopac.tar -C build mopac
          tar -rf mopac.tar -C $CONDA/lib libiomp5.dylib

      - name: Save executable as an artifact
        uses: actions/upload-artifact@v2
        with:
          name: mac
          path: mopac.tar

  windows-build:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - uses: msys2/setup-msys2@v2
        with:
          install: >-
            git
            make
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-gcc-fortran

      - uses: actions/checkout@v2

      - name: Install static MKL (BLAS & LAPACK) with Anaconda
        run: |
          $CONDA/Scripts/conda.exe install -c intel mkl-static
          echo "MKLROOT=$CONDA\Library" >> $GITHUB_ENV

      - name: Configure with CMake
        run: |
          cmake -B build \
            -G "MSYS Makefiles" \
            -DCMAKE_Fortran_COMPILER=gfortran \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_Fortran_FLAGS="-static-libgfortran -static-libgcc -l:libquadmath.a" \
            -DBLA_STATIC=ON \
            -DBLA_VENDOR=Intel10_64lp \
            -DCMAKE_FIND_DEBUG_MODE=true

      - name: Build with Make
        run: cmake --build build

      - name: Save executable as an artifact
        uses: actions/upload-artifact@v2
        with:
          name: windows
          path: build/mopac.exe

  continuous-deployment:
    runs-on: ubuntu-latest
    needs:
      - linux-build
      - mac-build
      - windows-build

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v2

      - name: Install GitHub Release
        run: |
          go get github.com/github-release/github-release
          echo "GOPATH=$(go env GOPATH)" >> $GITHUB_ENV
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Move/Create continuous tag
        run: |
          git tag --force continuous ${{ github.sha }}
          git push --tags --force

      - name: Assign GitHub user info for GitHub Release
        run: |
          echo "GITHUB_USER=$( echo ${{ github.repository }} | cut -d/ -f1 )" >> $GITHUB_ENV
          echo "GITHUB_REPO=$( echo ${{ github.repository }} | cut -d/ -f2 )" >> $GITHUB_ENV

      - name: Setup continuous release
        run: |
          DESCRIPTION="Triggered on $(date -u '+%Y/%m/%d, %H:%M') UTC by commit ${{ github.sha }} (@${{ github.actor }})

          This is an automated build of the latest source in the master branch.
          It is not an official release, and it is not intended for production work.

          Log: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          github-release edit \
            --tag continuous \
            --name "Continuous Build" \
            --description "$DESCRIPTION" \
            --pre-release

      - name: Download all artifacts
        uses: actions/download-artifact@v2
        with:
          path: ${{ github.workspace }}

      - name: Add executables to the continuous release
        run: |
          github-release upload \
            --tag continuous \
            --replace \
            --name mopac-linux-continuous.tar \
            --file linux/mopac.tar
          github-release upload \
            --tag continuous \
            --replace \
            --name mopac-mac-continuous.tar \
            --file mac/mopac.tar
          github-release upload \
            --tag continuous \
            --replace \
            --name mopac-windows-continuous.exe \
            --file windows/mopac.exe
