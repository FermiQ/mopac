name: CI/CD

on:
  push:
    branches:    
      - master
  pull_request:
    branches:
      - master
  schedule:
    - cron: "0 0 * * 0"

# Download links (not yet available in package managers) for the Intel Fortran compiler from:
# https://www.intel.com/content/www/us/en/developer/articles/tool/oneapi-standalone-components.html
env:
  IFORT_LINUX_URL: https://registrationcenter-download.intel.com/akdlm/irc_nas/18436/l_fortran-compiler_p_2022.0.1.70.sh
  IFORT_MAC_URL: https://registrationcenter-download.intel.com/akdlm/irc_nas/18357/m_fortran-compiler-classic_p_2022.0.0.63.dmg
  IFORT_WINDOWS_URL: https://registrationcenter-download.intel.com/akdlm/irc_nas/18412/w_fortran-compiler_p_2022.0.0.77.exe

jobs:
  linux-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Cache dependencies & build directory
        uses: actions/cache@v2
        with:
          path: |
            build
            $CONDA
            key: linux-cache

      - uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Download & install Intel Fortran compiler
        run: |
          curl $IFORT_LINUX_URL --output ifort_download.sh
          sudo sh ifort_download.sh -a --silent --eula accept

      - name: Clone glibc compatibility library
        uses: actions/checkout@v2
        with:
          repository: wheybags/glibc_version_header
          path: glibc

      - name: Install dependencies with PyPI
        run: python -m pip install numpy

      - name: Install dependencies with Anaconda
        run: |
          conda install -c intel mkl-static
          echo "MKLROOT=$CONDA" >> $GITHUB_ENV

      - name: Configure & build MOPAC with CMake
        run: |
          source /opt/intel/oneapi/setvars.sh
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_Fortran_COMPILER=ifort \
            -DCMAKE_Fortran_FLAGS="-static-intel" \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_C_FLAGS="-include $GITHUB_WORKSPACE/glibc/version_headers/x64/force_link_glibc_2.17.h" \
            -DBLA_STATIC=ON \
            -DBLA_VENDOR=Intel10_64lp
          cmake --build build

      - name: Test MOPAC with CTest
        run: |
          cd build
          ctest --verbose

      - name: Save test results as an artifact (on failure)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v2
        with:
          name: linux-test-output
          path: build/tests

      - name: Zip executable & shared libraries (including system libraries)
        run: |
          zip -j mopac.zip build/mopac
          zip -j mopac.zip build/libmopac_core.so*
          zip -j mopac.zip $CONDA/lib/libiomp5.so*

      - name: Save executable as an artifact
        uses: actions/upload-artifact@v2
        with:
          name: linux-dist
          path: mopac.zip

  mac-build:
    runs-on: macos-latest

    steps:

      - uses: actions/checkout@v2

      - name: Cache dependencies & build directory
        uses: actions/cache@v2
        with:
          path: |
            build
            $CONDA
            key: mac-cache

      - uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Download & install Intel Fortran compiler
        run: |
          curl $IFORT_MAC_URL --output ifort_download.dmg
          hdiutil attach ifort_download.dmg
          sudo /Volumes/m_fortran-compiler*/bootstrapper.app/Contents/MacOS/install.sh --silent --eula accept

      - name: Install dependencies with PyPI
        run: python -m pip install numpy

      - name: Install dependencies with Anaconda
        run: |
          sudo chown -R runner:staff $CONDA
          conda install -c intel mkl-static
          echo "MKLROOT=$CONDA" >> $GITHUB_ENV

      # an Intel-suggested hack is temporarily circumventing excessively slow calls to xcodebuild hidden in ifort, taken from:
      # https://community.intel.com/t5/Intel-oneAPI-HPC-Toolkit/slow-execution-of-ifort-icpc-on-MacOSX-catalina/m-p/1203190
      - name: Configure & build MOPAC with CMake
        run: |
          source /opt/intel/oneapi/setvars.sh
          mkdir xcode_hack
          echo -ne '#!/bin/bash\ncase "$4" in\n    "")\n      echo $INTEL_OSXSDK_VER;;\n     *)\n      echo $INTEL_OSXSDK_PATH;;\nesac\n' > xcode_hack/xcodebuild
          chmod 755 xcode_hack/xcodebuild
          export INTEL_OSXSDK_VER=`xcodebuild -sdk macosx -version | grep SDKVersion`
          export INTEL_OSXSDK_PATH=`xcodebuild -sdk macosx -version Path`
          export PATH=$GITHUB_WORKSPACE/xcode_hack:${PATH}
          cmake -B build \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.8 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_Fortran_COMPILER=ifort \
            -DCMAKE_Fortran_FLAGS="-static-intel" \
            -DCMAKE_C_COMPILER=gcc \
            -DBLA_VENDOR=Intel10_64lp
          cmake --build build

      - name: Test MOPAC with CTest
        run: |
          cd build
          ctest --verbose

      - name: Save test results as an artifact (on failure)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v2
        with:
          name: mac-test-output
          path: build/tests

      - name: Zip executable & shared libraries (including system libraries)
        run: |
          zip -j mopac.zip build/mopac
          zip -j mopac.zip build/libmopac_core*.dylib
          zip -j mopac.zip $CONDA/lib/libiomp5.dylib

      - name: Save executable as an artifact
        uses: actions/upload-artifact@v2
        with:
          name: mac-dist
          path: mopac.zip

  windows-build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v2

      - name: Cache dependencies & build directory
        uses: actions/cache@v2
        with:
          path: |
            build
            $CONDA
            key: windows-cache

      - uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Download & install Intel Fortran compiler
        shell: cmd
        run: |
          curl ${{ env.IFORT_WINDOWS_URL }} --output ifort_download.exe
          ifort_download -s -x -f ifort_unpack
          ifort_unpack\bootstrapper --silent --eula accept -p=NEED_VS2017_INTEGRATION=0 -p=NEED_VS2019_INTEGRATION=0

      - name: Install dependencies with PyPI
        run: python -m pip install numpy

      - name: Install dependencies with Anaconda
        shell: bash
        run: |
          $CONDA/Scripts/conda install -c intel mkl-static
          echo "MKLROOT=$CONDA/Library/lib" >> $GITHUB_ENV

      - name: Configure & build MOPAC with CMake
        shell: cmd
        run: |
          call "C:\Program Files (x86)\Intel\oneAPI\setvars.bat"
          cmake -Bbuild ^
            -G"NMake Makefiles" ^
            -DCMAKE_Fortran_FLAGS="/libs:static" ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_LIBRARY_PATH="%CONDA%/Library/lib;%CONDA%/Library/bin" ^
            -DBLA_STATIC=ON ^
            -DBLA_VENDOR=Intel10_64lp
          cmake --build build
          cp %CONDA%/Library/bin/libiomp5md.dll build

      - name: Test MOPAC with CTest
        run: |
          cd build
          ctest --verbose

      - name: Save test results as an artifact (on failure)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v2
        with:
          name: windows-test-output
          path: build/tests

      - name: Zip executable & shared libraries (including system libraries)
        run: |
          Compress-Archive -Path build/mopac.exe -DestinationPath mopac.zip
          Compress-Archive -Update -Path build/mopac_core.dll -DestinationPath mopac.zip
          Compress-Archive -Update -Path build/libiomp5md.dll -DestinationPath mopac.zip

      - name: Save executable as an artifact
        uses: actions/upload-artifact@v2
        with:
          name: windows-dist
          path: mopac.zip

  continuous-deployment:
    runs-on: ubuntu-latest
    needs:
      - linux-build
      - mac-build
      - windows-build

    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v2

      - name: Move/Create continuous tag
        run: |
          git tag --force continuous ${{ github.sha }}
          git push --tags --force

      - name: Assign GitHub user info for GitHub Release
        run: |
          echo "GITHUB_USER=$( echo ${{ github.repository }} | cut -d/ -f1 )" >> $GITHUB_ENV
          echo "GITHUB_REPO=$( echo ${{ github.repository }} | cut -d/ -f2 )" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v2
        with:
          path: ${{ github.workspace }}

      - name: Delete & recreate the continuous build
        run: |
          DESCRIPTION="This is an automated build of the latest source in the master branch.
          It is not an official release, and it is not intended for production work.

          GHA log: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          mv linux-dist/mopac.zip mopac-linux-continuous.zip
          mv mac-dist/mopac.zip mopac-mac-continuous.zip
          mv windows-dist/mopac.zip mopac-windows-continuous.zip
          gh release delete continuous --yes
          gh release create continuous --prerelease \
            --title "Continuous Build" \
            --notes "$DESCRIPTION" \
            mopac-linux-continuous.zip
            mopac-mac-continuous.zip
            mopac-windows-continuous.zip
